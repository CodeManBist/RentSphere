<%- layout('/layouts/boilerplate') %>

<div class="container mt-4">
  <div class="row">
    <div class="col-12">

      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>
          <i class="fa-solid fa-suitcase-rolling me-2 text-primary"></i>
          My Trips
        </h2>
        <a href="/listings" class="btn btn-primary">
          <i class="fa-solid fa-search me-1"></i>Browse Listings
        </a>
      </div>

      <% if (!bookings || bookings.length === 0) { %>
      <div class="text-center py-5">
        <i class="fa-solid fa-plane-slash fa-3x text-muted mb-3"></i>
        <h4 class="text-muted">No Trips Booked Yet</h4>
        <p class="text-muted">Start exploring amazing listings.</p>
        <a href="/listings" class="btn btn-primary">Browse Listings</a>
      </div>
      <% } else { %>

      <!-- Upcoming Trips Section -->
      <% if (upcomingTrips && upcomingTrips.length > 0) { %>
      <div class="mb-4">
        <h4 class="mb-3"><i class="fa-solid fa-plane-departure me-2 text-primary"></i>Upcoming Trips</h4>
        <div class="row g-3">
          <% upcomingTrips.forEach(booking => { %>
          <div class="col-md-6">
            <div class="card shadow-sm h-100 border-0">
              <div class="row g-0">
                <div class="col-4">
                  <% if (booking.listing && booking.listing.image && booking.listing.image.url) { %>
                  <img src="<%= booking.listing.image.url %>" class="img-fluid rounded-start h-100" 
                       style="object-fit: cover;" alt="<%= booking.listing.title %>">
                  <% } else { %>
                  <div class="bg-light h-100 d-flex align-items-center justify-content-center">
                    <span class="text-muted small">No Image</span>
                  </div>
                  <% } %>
                </div>
                <div class="col-8">
                  <div class="card-body py-2">
                    <h6 class="card-title mb-1"><%= booking.listing ? booking.listing.title : "Listing Removed" %></h6>
                    <p class="small text-muted mb-1">
                      <i class="fa-solid fa-calendar me-1"></i>
                      <%= booking.checkIn.toLocaleDateString() %> - <%= booking.checkOut.toLocaleDateString() %>
                    </p>
                    <p class="small mb-2">
                      <span class="badge bg-success">Confirmed</span>
                      <span class="badge bg-success ms-1">Paid</span>
                    </p>
                    <a href="/bookings/booking/<%= booking._id %>" class="btn btn-outline-primary btn-sm">
                      View Details
                    </a>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <% }) %>
        </div>
      </div>
      <% } %>

      <!-- Pending Bookings with status indicators -->
      <% if (pendingBookings && pendingBookings.length > 0) { %>
      <div class="mb-4">
        <h4 class="mb-3"><i class="fa-solid fa-hourglass-half me-2 text-warning"></i>Pending Bookings</h4>
        <div class="row g-3">
          <% pendingBookings.forEach(booking => { %>
          <div class="col-md-6">
            <div class="card shadow-sm h-100 border-0">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-2">
                  <h6 class="card-title mb-0"><%= booking.listing ? booking.listing.title : "Listing Removed" %></h6>
                  <% if (booking.status === 'pending_payment') { %>
                  <span class="badge bg-danger">Payment Required</span>
                  <% } else if (booking.status === 'paid' || booking.status === 'pending_approval') { %>
                  <span class="badge bg-warning text-dark">Awaiting Host</span>
                  <% } %>
                </div>
                
                <p class="small text-muted mb-1">
                  <i class="fa-solid fa-calendar me-1"></i>
                  <%= booking.checkIn.toLocaleDateString() %> - <%= booking.checkOut.toLocaleDateString() %>
                </p>
                <p class="small mb-2">
                  <strong>â‚¹<%= booking.pricing.total.toLocaleString('en-IN') %></strong>
                </p>

                <div class="d-flex gap-2">
                  <% if (booking.status === 'pending_payment') { %>
                  <a href="/payments/pay/<%= booking._id %>" class="btn btn-primary btn-sm">
                    <i class="fa-solid fa-credit-card me-1"></i>Complete Payment
                  </a>
                  <% } else { %>
                  <div class="alert alert-info py-1 px-2 mb-0 small flex-grow-1">
                    <i class="fa-solid fa-info-circle me-1"></i>
                    Waiting for host to accept your request
                  </div>
                  <% } %>
                  <a href="/bookings/booking/<%= booking._id %>" class="btn btn-outline-secondary btn-sm">
                    Details
                  </a>
                </div>
              </div>
            </div>
          </div>
          <% }) %>
        </div>
      </div>
      <% } %>

      <!-- Cancelled bookings with refund messaging -->
      <% if (cancelledBookings && cancelledBookings.length > 0) { %>
      <div class="mb-4">
        <h4 class="mb-3"><i class="fa-solid fa-ban me-2 text-danger"></i>Cancelled Bookings</h4>
        <% cancelledBookings.forEach(booking => { %>
        <div class="card mb-3 shadow-sm border-0">
          <div class="card-body">
            <div class="row align-items-center">
              <div class="col-md-8">
                <h6 class="mb-1"><%= booking.listing ? booking.listing.title : "Listing Removed" %></h6>
                <p class="small text-muted mb-1">
                  <%= booking.checkIn.toLocaleDateString() %> - <%= booking.checkOut.toLocaleDateString() %>
                </p>
                <span class="badge bg-<%= booking.status === 'rejected' ? 'warning' : 'danger' %>">
                  <%= booking.status === 'rejected' ? 'Declined by Host' : 'Cancelled' %>
                </span>
              </div>
              <div class="col-md-4">
                <!-- Refund Message Display -->
                <% if (booking.refundMessage) { %>
                <div class="alert alert-<%= booking.refundMessage.icon && booking.refundMessage.icon.includes('check') ? 'success' : 'info' %> py-2 px-3 mb-0">
                  <i class="<%= booking.refundMessage.icon || 'fa-solid fa-info-circle' %> me-2"></i>
                  <strong><%= booking.refundMessage.title %></strong>
                  <p class="mb-0 small"><%= booking.refundMessage.message %></p>
                </div>
                <% } else if (booking.cancellation && booking.cancellation.refundStatus) { %>
                <div class="alert alert-info py-2 px-3 mb-0">
                  <i class="fa-solid fa-rotate me-2"></i>
                  <strong>Refund <%= booking.cancellation.refundStatus %></strong>
                  <% if (booking.cancellation.refundMessage) { %>
                  <p class="mb-0 small"><%= booking.cancellation.refundMessage %></p>
                  <% } %>
                </div>
                <% } %>
              </div>
            </div>
          </div>
        </div>
        <% }) %>
      </div>
      <% } %>

      <!-- Past Trips -->
      <% if (pastTrips && pastTrips.length > 0) { %>
      <div class="mb-4">
        <h4 class="mb-3"><i class="fa-solid fa-history me-2 text-secondary"></i>Past Trips</h4>
        <div class="row g-3">
          <% pastTrips.forEach(booking => { %>
          <div class="col-md-4">
            <div class="card shadow-sm h-100">
              <% if (booking.listing && booking.listing.image && booking.listing.image.url) { %>
              <img src="<%= booking.listing.image.url %>" class="card-img-top" 
                   style="height: 120px; object-fit: cover;" alt="<%= booking.listing.title %>">
              <% } %>
              <div class="card-body py-2">
                <h6 class="card-title mb-1 text-truncate"><%= booking.listing ? booking.listing.title : "Removed" %></h6>
                <p class="small text-muted mb-2"><%= booking.checkIn.toLocaleDateString() %></p>
                <a href="/listings/<%= booking.listing ? booking.listing._id : '' %>" class="btn btn-outline-primary btn-sm w-100">
                  Book Again
                </a>
              </div>
            </div>
          </div>
          <% }) %>
        </div>
      </div>
      <% } %>

      <% } %>

    </div>
  </div>
</div>
