<%- layout('/layouts/boilerplate') %>

<div class="container mt-4">
  <div class="row">
    <div class="col-12">

      <!-- HEADER -->
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>
          <i class="fa-solid fa-chart-line me-2 text-primary"></i>
          Host Dashboard
        </h2>
        <div>
          <a href="/listings/new" class="btn btn-primary me-2">
            <i class="fa-solid fa-plus me-1"></i>New Listing
          </a>
          <a href="/listings" class="btn btn-outline-primary">
            <i class="fa-solid fa-list me-1"></i>All Listings
          </a>
        </div>
      </div>

      <!-- Enhanced stats with analytics -->
      <div class="row mb-4 g-3">
        <div class="col-6 col-md-3">
          <div class="card bg-warning text-white text-center h-100">
            <div class="card-body py-3">
              <h4 class="mb-1"><%= pendingApproval ? pendingApproval.length : 0 %></h4>
              <p class="mb-0 small">Awaiting Approval</p>
            </div>
          </div>
        </div>
        <div class="col-6 col-md-3">
          <div class="card bg-success text-white text-center h-100">
            <div class="card-body py-3">
              <h4 class="mb-1"><%= confirmedBookings ? confirmedBookings.length : 0 %></h4>
              <p class="mb-0 small">Confirmed</p>
            </div>
          </div>
        </div>
        <div class="col-6 col-md-3">
          <div class="card bg-primary text-white text-center h-100">
            <div class="card-body py-3">
              <h4 class="mb-1">₹<%= analytics ? analytics.totalEarnings.toLocaleString('en-IN') : 0 %></h4>
              <p class="mb-0 small">Total Earnings</p>
            </div>
          </div>
        </div>
        <div class="col-6 col-md-3">
          <div class="card bg-info text-white text-center h-100">
            <div class="card-body py-3">
              <h4 class="mb-1"><%= analytics ? analytics.occupancyRate : 0 %>%</h4>
              <p class="mb-0 small">Occupancy (30d)</p>
            </div>
          </div>
        </div>
      </div>

      <!-- New booking flow info banner -->
      <div class="alert alert-info mb-4">
        <i class="fa-solid fa-info-circle me-2"></i>
        <strong>New Booking Flow:</strong> Guests now pay first to secure dates. Review requests below and accept or decline. 
        Declined bookings will be automatically refunded within 24 hours.
      </div>

      <!-- PENDING APPROVAL (Paid, awaiting host decision) -->
      <% if (pendingApproval && pendingApproval.length > 0) { %>
      <div class="card mb-4 border-warning">
        <div class="card-header bg-warning text-dark">
          <h5 class="mb-0">
            <i class="fa-solid fa-clock me-2"></i>
            Awaiting Your Approval (<%= pendingApproval.length %>)
          </h5>
        </div>

        <div class="card-body">
          <% pendingApproval.forEach(booking => { %>

          <div class="card mb-3 shadow-sm border-start border-warning border-4">
            <div class="card-body">
              <div class="row align-items-center">

                <!-- IMAGE -->
                <div class="col-md-2">
                  <% if (booking.listing && booking.listing.image && booking.listing.image.url) { %>
                  <img 
                    src="<%= booking.listing.image.url %>" 
                    class="img-fluid rounded"
                    style="height: 80px; width: 100%; object-fit: cover;"
                    alt="<%= booking.listing.title %>"
                  >
                  <% } else { %>
                  <div class="bg-light border rounded p-3 text-muted text-center small">
                    No Image
                  </div>
                  <% } %>
                </div>

                <!-- INFO -->
                <div class="col-md-5">
                  <h6 class="mb-1">
                    <%= booking.listing ? booking.listing.title : "Listing Removed" %>
                  </h6>

                  <p class="mb-1 small"><strong>Guest:</strong> @<%= booking.guest ? booking.guest.username : 'Unknown' %></p>
                  <p class="mb-1 small">
                    <strong>Dates:</strong> <%= booking.checkIn.toLocaleDateString() %> - <%= booking.checkOut.toLocaleDateString() %>
                    (<%= booking.pricing.nights %> <%= booking.pricing.pricingUnit || 'night' %>s)
                  </p>
                  <p class="mb-1 small"><strong>Guests:</strong> <%= booking.guestCount.adults %></p>

                  <% if (booking.guestMessage) { %>
                  <p class="mb-1 small fst-italic">"<%= booking.guestMessage %>"</p>
                  <% } %>
                </div>

                <!-- PAYMENT & PRICE -->
                <div class="col-md-2 text-center">
                  <span class="badge bg-success mb-2">
                    <i class="fa-solid fa-check-circle me-1"></i>Paid
                  </span>
                  <p class="fw-bold text-success mb-0">₹<%= booking.pricing.total.toLocaleString('en-IN') %></p>
                </div>

                <!-- ACTIONS -->
                <div class="col-md-3">
                  <div class="d-flex flex-column gap-2">
                    <form action="/bookings/booking/<%= booking._id %>/accept" method="POST">
                      <button class="btn btn-success w-100 btn-sm">
                        <i class="fa-solid fa-check me-1"></i>Accept Booking
                      </button>
                    </form>

                    <button type="button" class="btn btn-outline-danger btn-sm" 
                            data-bs-toggle="modal" data-bs-target="#rejectModal<%= booking._id %>">
                      <i class="fa-solid fa-xmark me-1"></i>Decline
                    </button>
                    
                    <a href="/bookings/booking/<%= booking._id %>" class="btn btn-outline-secondary btn-sm">
                      <i class="fa-solid fa-eye me-1"></i>Details
                    </a>
                  </div>
                </div>

              </div>
            </div>
          </div>

          <!-- Rejection Modal -->
          <div class="modal fade" id="rejectModal<%= booking._id %>" tabindex="-1">
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title">Decline Booking</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form action="/bookings/booking/<%= booking._id %>/reject" method="POST">
                  <div class="modal-body">
                    <div class="alert alert-warning">
                      <i class="fa-solid fa-exclamation-triangle me-2"></i>
                      The guest will receive a full refund within 24 hours.
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Reason (optional)</label>
                      <textarea name="reason" class="form-control" rows="3" 
                                placeholder="Let the guest know why you can't host them..."></textarea>
                    </div>
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">Decline & Refund</button>
                  </div>
                </form>
              </div>
            </div>
          </div>

          <% }) %>
        </div>
      </div>
      <% } %>

      <!-- CONFIRMED BOOKINGS -->
      <% if (confirmedBookings && confirmedBookings.length > 0) { %>
      <div class="card mb-4 border-success">
        <div class="card-header bg-success text-white">
          <h5 class="mb-0">
            <i class="fa-solid fa-calendar-check me-2"></i>
            Confirmed Bookings (<%= confirmedBookings.length %>)
          </h5>
        </div>

        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover mb-0">
              <thead>
                <tr>
                  <th>Listing</th>
                  <th>Guest</th>
                  <th>Dates</th>
                  <th>Amount</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <% confirmedBookings.forEach(booking => { %>
                <tr>
                  <td>
                    <div class="d-flex align-items-center">
                      <% if (booking.listing && booking.listing.image && booking.listing.image.url) { %>
                      <img src="<%= booking.listing.image.url %>" class="rounded me-2" 
                           style="width: 40px; height: 40px; object-fit: cover;">
                      <% } %>
                      <span class="text-truncate" style="max-width: 150px;">
                        <%= booking.listing ? booking.listing.title : "Removed" %>
                      </span>
                    </div>
                  </td>
                  <td>@<%= booking.guest ? booking.guest.username : 'Unknown' %></td>
                  <td>
                    <%= booking.checkIn.toLocaleDateString() %> - <%= booking.checkOut.toLocaleDateString() %>
                  </td>
                  <td class="text-success fw-bold">₹<%= booking.pricing.total.toLocaleString('en-IN') %></td>
                  <td>
                    <a href="/bookings/booking/<%= booking._id %>" class="btn btn-outline-primary btn-sm">
                      View
                    </a>
                  </td>
                </tr>
                <% }) %>
              </tbody>
            </table>
          </div>
        </div>
      </div>
      <% } %>

      <!-- Cancelled/Rejected with refund status -->
      <% if (cancelledBookings && cancelledBookings.length > 0) { %>
      <div class="card mb-4 border-secondary">
        <div class="card-header bg-secondary text-white">
          <h5 class="mb-0">
            <i class="fa-solid fa-ban me-2"></i>
            Cancelled/Declined (<%= cancelledBookings.length %>)
          </h5>
        </div>
        <div class="card-body">
          <% cancelledBookings.slice(0, 5).forEach(booking => { %>
          <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
            <div>
              <strong><%= booking.listing ? booking.listing.title : "Removed" %></strong>
              <span class="text-muted ms-2">@<%= booking.guest ? booking.guest.username : 'Unknown' %></span>
            </div>
            <div class="text-end">
              <span class="badge bg-<%= booking.status === 'rejected' ? 'warning' : 'danger' %>">
                <%= booking.status === 'rejected' ? 'Declined' : 'Cancelled' %>
              </span>
              <% if (booking.cancellation && booking.cancellation.refundStatus) { %>
              <span class="badge bg-<%= booking.cancellation.refundStatus === 'completed' ? 'success' : 'info' %> ms-1">
                Refund: <%= booking.cancellation.refundStatus %>
              </span>
              <% } %>
            </div>
          </div>
          <% }) %>
        </div>
      </div>
      <% } %>

      <!-- EMPTY STATE -->
      <% if (!bookings || bookings.length === 0) { %>
      <div class="text-center py-5">
        <i class="fa-solid fa-calendar-xmark fa-3x text-muted mb-3"></i>
        <h4>No Bookings Yet</h4>
        <p class="text-muted">When guests book your listings, they will appear here.</p>
        <a href="/listings/new" class="btn btn-primary">Create a Listing</a>
      </div>
      <% } %>

    </div>
  </div>
</div>
